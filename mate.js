// Generated by CoffeeScript 1.6.3
/*
Mate
https://github.com/zhanzhenzhen/mate
(c) 2013 Zhenzhen Zhan
Mate may be freely distributed under the MIT license.
*/

var ArrayLazyWrapper, ObjectWithEvents, assert, compose, fail, repeat, spread,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

ArrayLazyWrapper = (function() {
  function ArrayLazyWrapper(value, chainToCopy, itemToPush) {
    var _this = this;
    this._value = value;
    this._chain = (chainToCopy != null ? chainToCopy : []).slice(0);
    if (itemToPush != null) {
      this._chain.push(itemToPush);
    }
    Object.getter(this, "length", function() {
      return _this.force().length;
    });
  }

  ArrayLazyWrapper.prototype.force = function() {
    var m, n, _i, _len, _ref;
    n = this._value;
    _ref = this._chain;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      m = _ref[_i];
      n = m.fun.apply(n, m.args);
    }
    return n;
  };

  ArrayLazyWrapper.prototype.map = function() {
    return this._pushChain(Array.prototype.map, arguments);
  };

  ArrayLazyWrapper.prototype.filter = function() {
    return this._pushChain(Array.prototype.filter, arguments);
  };

  ArrayLazyWrapper.prototype.concat = function() {
    return this._pushChain(Array.prototype.concat, arguments);
  };

  ArrayLazyWrapper.prototype.portion = function() {
    return this._pushChain(Array.prototype.portion, arguments);
  };

  ArrayLazyWrapper.prototype.funSort = function() {
    return this._pushChain(Array.prototype.funSort, arguments);
  };

  ArrayLazyWrapper.prototype.funSortDescending = function() {
    return this._pushChain(Array.prototype.funSortDescending, arguments);
  };

  ArrayLazyWrapper.prototype.funReverse = function() {
    return this._pushChain(Array.prototype.funReverse, arguments);
  };

  ArrayLazyWrapper.prototype.except = function() {
    return this._pushChain(Array.prototype.except, arguments);
  };

  ArrayLazyWrapper.prototype.flatten = function() {
    return this._pushChain(Array.prototype.flatten, arguments);
  };

  ArrayLazyWrapper.prototype.random = function() {
    return this._pushChain(Array.prototype.random, arguments);
  };

  ArrayLazyWrapper.prototype.some = function() {
    return this._unwrapAndDo(Array.prototype.some, arguments);
  };

  ArrayLazyWrapper.prototype.every = function() {
    return this._unwrapAndDo(Array.prototype.every, arguments);
  };

  ArrayLazyWrapper.prototype.isEmpty = function() {
    return this._unwrapAndDo(Array.prototype.isEmpty, arguments);
  };

  ArrayLazyWrapper.prototype.at = function() {
    return this._unwrapAndDo(Array.prototype.at, arguments);
  };

  ArrayLazyWrapper.prototype.atOrNull = function() {
    return this._unwrapAndDo(Array.prototype.atOrNull, arguments);
  };

  ArrayLazyWrapper.prototype.contains = function() {
    return this._unwrapAndDo(Array.prototype.contains, arguments);
  };

  ArrayLazyWrapper.prototype.first = function() {
    return this._unwrapAndDo(Array.prototype.first, arguments);
  };

  ArrayLazyWrapper.prototype.firstOrNull = function() {
    return this._unwrapAndDo(Array.prototype.firstOrNull, arguments);
  };

  ArrayLazyWrapper.prototype.last = function() {
    return this._unwrapAndDo(Array.prototype.last, arguments);
  };

  ArrayLazyWrapper.prototype.lastOrNull = function() {
    return this._unwrapAndDo(Array.prototype.lastOrNull, arguments);
  };

  ArrayLazyWrapper.prototype.single = function() {
    return this._unwrapAndDo(Array.prototype.single, arguments);
  };

  ArrayLazyWrapper.prototype.singleOrNull = function() {
    return this._unwrapAndDo(Array.prototype.singleOrNull, arguments);
  };

  ArrayLazyWrapper.prototype.withMax = function() {
    return this._unwrapAndDo(Array.prototype.withMax, arguments);
  };

  ArrayLazyWrapper.prototype.withMin = function() {
    return this._unwrapAndDo(Array.prototype.withMin, arguments);
  };

  ArrayLazyWrapper.prototype.max = function() {
    return this._unwrapAndDo(Array.prototype.max, arguments);
  };

  ArrayLazyWrapper.prototype.min = function() {
    return this._unwrapAndDo(Array.prototype.min, arguments);
  };

  ArrayLazyWrapper.prototype.sum = function() {
    return this._unwrapAndDo(Array.prototype.sum, arguments);
  };

  ArrayLazyWrapper.prototype.average = function() {
    return this._unwrapAndDo(Array.prototype.average, arguments);
  };

  ArrayLazyWrapper.prototype.randomOne = function() {
    return this._unwrapAndDo(Array.prototype.randomOne, arguments);
  };

  ArrayLazyWrapper.prototype._pushChain = function(fun, args) {
    return new ArrayLazyWrapper(this._value, this._chain, {
      fun: fun,
      args: args
    });
  };

  ArrayLazyWrapper.prototype._unwrapAndDo = function(fun, args) {
    return fun.apply(this.force(), args);
  };

  return ArrayLazyWrapper;

})();

Array._elementOrUseSelector = function(element, selector) {
  if (selector != null) {
    return selector(element);
  } else {
    return element;
  }
};

Array.prototype._numberToIndex = function(pos) {
  if ((0 < pos && pos < 1)) {
    return pos = Math.round(pos * (this.length - 1));
  } else {
    return pos;
  }
};

Array.prototype._numberToLength = function(pos) {
  if ((0 < pos && pos < 1)) {
    return pos = Math.round(pos * this.length);
  } else {
    return pos;
  }
};

Array.prototype.copy = function() {
  return this.slice(0);
};

Array.prototype.isEmpty = function() {
  return this.length === 0;
};

Array.prototype.lazy = function() {
  return new ArrayLazyWrapper(this);
};

Array.prototype.portion = function(startIndex, length, endIndex) {
  startIndex = this._numberToIndex(startIndex);
  length = this._numberToLength(length);
  endIndex = this._numberToIndex(endIndex);
  return this.slice(startIndex, length != null ? startIndex + length : endIndex);
};

Array.prototype.at = function(index) {
  index = this._numberToIndex(index);
  assert((0 <= index && index < this.length));
  return this[index];
};

Array.prototype.atOrNull = function(index) {
  try {
    return this.at(index);
  } catch (_error) {
    return null;
  }
};

Array.prototype.contains = function(value) {
  return __indexOf.call(this, value) >= 0;
};

Array.prototype.first = function(predicate) {
  var queryResult;
  queryResult = predicate != null ? this.filter(predicate) : this;
  return queryResult.at(0);
};

Array.prototype.firstOrNull = function(predicate) {
  try {
    return this.first(predicate);
  } catch (_error) {
    return null;
  }
};

Array.prototype.last = function(predicate) {
  var queryResult;
  queryResult = predicate != null ? this.filter(predicate) : this;
  return queryResult.at(queryResult.length - 1);
};

Array.prototype.lastOrNull = function(predicate) {
  try {
    return this.last(predicate);
  } catch (_error) {
    return null;
  }
};

Array.prototype.single = function(predicate) {
  var queryResult;
  queryResult = predicate != null ? this.filter(predicate) : this;
  assert(queryResult.length === 1);
  return queryResult.at(0);
};

Array.prototype.singleOrNull = function(predicate) {
  try {
    return this.single(predicate);
  } catch (_error) {
    return null;
  }
};

Array.prototype.withMax = function(selector) {
  var _this = this;
  return this.reduce(function(a, b, index) {
    if (Array._elementOrUseSelector(a, selector) > Array._elementOrUseSelector(b, selector)) {
      return a;
    } else {
      return b;
    }
  });
};

Array.prototype.withMin = function(selector) {
  var _this = this;
  return this.reduce(function(a, b, index) {
    if (Array._elementOrUseSelector(a, selector) < Array._elementOrUseSelector(b, selector)) {
      return a;
    } else {
      return b;
    }
  });
};

Array.prototype.max = function(selector) {
  return Array._elementOrUseSelector(this.withMax(selector), selector);
};

Array.prototype.min = function(selector) {
  return Array._elementOrUseSelector(this.withMin(selector), selector);
};

Array.prototype.sum = function(selector) {
  var _this = this;
  return this.reduce(function(a, b, index) {
    return (index === 1 ? Array._elementOrUseSelector(a, selector) : a) + Array._elementOrUseSelector(b, selector);
  });
};

Array.prototype.average = function(selector) {
  return this.sum(selector) / this.length;
};

Array.prototype._sort = function(keySelector, isDescending) {
  var _this = this;
  return this.copy().sort(function(a, b) {
    var a1, b1;
    a1 = Array._elementOrUseSelector(a, keySelector);
    b1 = Array._elementOrUseSelector(b, keySelector);
    if (a1 < b1) {
      if (isDescending) {
        return 1;
      } else {
        return -1;
      }
    } else if (a1 > b1) {
      if (isDescending) {
        return -1;
      } else {
        return 1;
      }
    } else {
      return 0;
    }
  });
};

Array.prototype.funSort = function(keySelector) {
  return this._sort(keySelector, false);
};

Array.prototype.funSortDescending = function(keySelector) {
  return this._sort(keySelector, true);
};

Array.prototype.funReverse = function() {
  return this.copy().reverse();
};

Array.prototype.except = function(array) {
  return this.filter(function(m) {
    return __indexOf.call(array, m) < 0;
  });
};

Array.prototype.flatten = function(level) {
  var canContinue, m, n, r, _i, _j, _len, _len1;
  if (level <= 0) {
    return fail();
  } else {
    r = [];
    canContinue = false;
    for (_i = 0, _len = this.length; _i < _len; _i++) {
      m = this[_i];
      if (Array.isArray(m)) {
        canContinue = true;
        for (_j = 0, _len1 = m.length; _j < _len1; _j++) {
          n = m[_j];
          r.push(n);
        }
      } else {
        r.push(m);
      }
    }
    if (canContinue) {
      if (level != null) {
        if (level === 1) {
          return r;
        } else {
          return r.flatten(level - 1);
        }
      } else {
        return r.flatten();
      }
    } else {
      return r;
    }
  }
};

Array.prototype.randomOne = function() {
  return this[Math.randomInt(this.length)];
};

Array.prototype.random = function(count) {
  return this.copy().takeRandom(count);
};

Array.prototype.takeRandomOne = function() {
  var index, r;
  index = Math.randomInt(this.length);
  r = this[index];
  this.removeAt(index);
  return r;
};

Array.prototype.takeRandom = function(count) {
  var _this = this;
  if (count == null) {
    count = this.length;
  }
  count = this._numberToLength(count);
  return repeat(count, function() {
    return _this.takeRandomOne();
  });
};

Array.prototype.removeAt = function(index) {
  this.splice(index, 1);
  return this;
};

Array.prototype.remove = function(element) {
  var index;
  index = this.indexOf(element);
  assert(index > -1);
  return this.removeAt(index);
};

Array.prototype.removeAll = function(element) {
  var index;
  while (true) {
    index = this.indexOf(element);
    if (index === -1) {
      break;
    }
    this.removeAt(index);
  }
  return this;
};

Array.prototype.removeMatch = function(predicate) {
  var index;
  index = this.findIndex(predicate);
  assert(index > -1);
  return this.removeAt(index);
};

Array.prototype.removeAllMatch = function(predicate) {
  var index;
  while (true) {
    index = this.findIndex(predicate);
    if (index === -1) {
      break;
    }
    this.removeAt(index);
  }
  return this;
};

if (String.prototype.startsWith === void 0) {
  String.prototype.startsWith = function(s) {
    return this.indexOf(s) === 0;
  };
}

if (String.prototype.endsWith === void 0) {
  String.prototype.endsWith = function(s) {
    return this.lastIndexOf(s) === this.length - s.length;
  };
}

if (String.prototype.contains === void 0) {
  String.prototype.contains = function(s) {
    return this.indexOf(s) !== -1;
  };
}

if (Array.from === void 0) {
  Array.from = function(arrayLike) {
    var m, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = arrayLike.length; _i < _len; _i++) {
      m = arrayLike[_i];
      _results.push(m);
    }
    return _results;
  };
}

if (Array.prototype.find === void 0) {
  Array.prototype.find = function(predicate) {
    var found;
    assert(typeof predicate === "function");
    found = this.filter(predicate);
    if (!found.isEmpty()) {
      return found.at(0);
    } else {
      return void 0;
    }
  };
}

if (Array.prototype.findIndex === void 0) {
  Array.prototype.findIndex = function(predicate) {
    var element;
    element = this.find(predicate);
    if (element === void 0) {
      return -1;
    } else {
      return this.indexOf(element);
    }
  };
}

compose = function(functions) {
  if (arguments.length > 1) {
    functions = Array.from(arguments);
  }
  return function() {
    var args, m, _i, _len;
    args = arguments;
    for (_i = 0, _len = functions.length; _i < _len; _i++) {
      m = functions[_i];
      args = [m.apply(this, args)];
    }
    return args[0];
  };
};

fail = function(errorMessage) {
  throw new Error(errorMessage);
};

assert = function(condition, message) {
  if (!condition) {
    return fail(message);
  }
};

repeat = function(times, iterator) {
  var i, _i, _results;
  _results = [];
  for (i = _i = 0; 0 <= times ? _i < times : _i > times; i = 0 <= times ? ++_i : --_i) {
    _results.push(iterator());
  }
  return _results;
};

spread = function(value, count) {
  var i, _i, _results;
  _results = [];
  for (i = _i = 0; 0 <= count ? _i < count : _i > count; i = 0 <= count ? ++_i : --_i) {
    _results.push(value);
  }
  return _results;
};

Object.getter = function(obj, prop, fun) {
  return Object.defineProperty(obj, prop, {
    get: fun,
    configurable: true
  });
};

Object.setter = function(obj, prop, fun) {
  return Object.defineProperty(obj, prop, {
    set: fun,
    configurable: true
  });
};

Object.clone = function(x) {
  var key, y, _i, _len, _ref;
  y = {};
  _ref = Object.keys(x);
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    key = _ref[_i];
    y[key] = x[key];
  }
  return y;
};

JSON.clone = function(x) {
  return JSON.parse(JSON.stringify(x));
};

Number.parseFloatExt = function(s) {
  return parseFloat(s) * (s.endsWith("%") ? 0.01 : 1);
};

Math.radiansToDegrees = function(radians) {
  var d, rd;
  d = radians / Math.PI * 180;
  rd = Math.round(d);
  if (Math.abs(d - rd) < 0.0001) {
    return rd;
  } else {
    return d;
  }
};

Math.degreesToRadians = function(degrees) {
  return degrees / 180 * Math.PI;
};

Math.randomNumber = function(m, n) {
  if (m < n) {
    return m + Math.random() * (n - m);
  } else {
    return fail();
  }
};

Math.randomInt = function(m, n) {
  var max, min;
  min = n === void 0 ? 0 : m;
  max = n === void 0 ? m : n;
  return Math.floor(Math.randomNumber(min, max));
};

String.prototype.matches = function(regex) {
  var adjustedRegex, match, result;
  adjustedRegex = new RegExp(regex.source, "g");
  result = [];
  while (true) {
    match = adjustedRegex.exec(this);
    if (match != null) {
      result.push(match);
    } else {
      break;
    }
  }
  return result;
};

String.prototype.capitalize = function() {
  return this.charAt(0).toUpperCase() + this.substr(1);
};

ObjectWithEvents = (function() {
  function ObjectWithEvents() {
    this._eventList = {};
  }

  ObjectWithEvents.prototype.on = function(eventName, listener) {
    var _base;
    if ((_base = this._eventList)[eventName] == null) {
      _base[eventName] = [];
    }
    if (__indexOf.call(this._eventList[eventName], listener) < 0) {
      return this._eventList[eventName].push(listener);
    }
  };

  ObjectWithEvents.prototype.off = function(eventName, listener) {
    return this._eventList[eventName].removeAll(listener);
  };

  ObjectWithEvents.prototype.trigger = function(eventName, arg) {
    var m, _base, _i, _len, _ref, _results;
    if ((_base = this._eventList)[eventName] == null) {
      _base[eventName] = [];
    }
    _ref = this._eventList[eventName];
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      m = _ref[_i];
      _results.push(m(arg));
    }
    return _results;
  };

  ObjectWithEvents.prototype.listeners = function(eventName) {
    return this._eventList[eventName];
  };

  return ObjectWithEvents;

})();

if ((typeof exports !== "undefined" && exports !== null) && ((typeof module !== "undefined" && module !== null ? module.exports : void 0) != null)) {
  global.compose = compose;
  global.fail = fail;
  global.assert = assert;
  global.repeat = repeat;
  global.spread = spread;
  global.ObjectWithEvents = ObjectWithEvents;
}
